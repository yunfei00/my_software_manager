{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>系统管理</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------- 通用函数：打开 modal 并加载内容 ----------
    async function openModal(url, title='表单') {
      const modalTitle = document.getElementById('commonModalLabel');
      const modalBody = document.getElementById('commonModalBody');
      modalTitle.innerText = title;
      modalBody.innerHTML = '<div class="text-center p-3">加载中...</div>';
      const modal = new bootstrap.Modal(document.getElementById('commonModal'));
      modal.show();

      try {
        const resp = await fetch(url, {credentials: 'same-origin'});
        const data = await resp.json();
        modalBody.innerHTML = data.html;
      } catch (e) {
        modalBody.innerHTML = '<div class="text-danger text-center p-3">加载失败，请重试。</div>';
      }
    }

    // ---------- 提交 modal 表单 ----------
    let submitting = false;
    async function submitModalForm(form, event) {
      if (event) event.preventDefault();  // 阻止浏览器默认提交行为
      if (submitting) return false;       // 防止重复点击
      submitting = true;

      const url = form.action;
      const formData = new FormData(form);

      try {
        const resp = await fetch(url, {
          method: 'POST',
          body: formData,
          credentials: 'same-origin',
          headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        const data = await resp.json();

        if (data.success) {
          location.reload();
        } else {
          // 替换 modal 内容（可能返回带错误提示的表单）
          document.getElementById('commonModalBody').innerHTML = data.html;
        }
      } catch (err) {
        alert('提交失败，请检查网络或稍后再试。');
      }

      submitting = false;
      return false;  // 阻止表单默认提交
    }

    // ---------- CSRF 辅助 ----------
    function getCookie(name) {
      const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }
  </script>
</head>

<body class="p-4">
  <div class="container">
    <h4 class="mb-4">系统管理 - 示例</h4>
    {% block content %}{% endblock %}
  </div>

  <!-- 公共 Modal -->
  <div class="modal fade" id="commonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="commonModalLabel">表单</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="commonModalBody"></div>
      </div>
    </div>
  </div>
</body>
</html>
